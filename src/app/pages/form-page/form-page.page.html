<ion-header>
  <ion-toolbar>
    <ion-title>{{ meta.name || 'Formulário' }}</ion-title>
  </ion-toolbar>
</ion-header>

@if (!loading && meta) {
  <ion-content>
    <form [formGroup]="fg" (ngSubmit)="submit()">
      <ion-list>
        @if (meta.has_driver) {
          <ion-item>
            <ion-label position="stacked">Motorista *</ion-label>
            <ion-select formControlName="driver_id" interface="popover" placeholder="Selecionar">
              @for (d of drivers; track d) {
                <ion-select-option [value]="d.id">{{ d.name }}</ion-select-option>
              }
            </ion-select>
          </ion-item>
        }
        @if (meta.has_license) {
          <ion-item>
            <ion-label position="stacked">Matrícula *</ion-label>
            <ion-select formControlName="vehicle_item_id" interface="popover" placeholder="Selecionar">
              @for (v of vehicle_items; track v) {
                <ion-select-option [value]="v.id">{{ v.license_plate }}</ion-select-option>
              }
            </ion-select>
          </ion-item>
        }
        @if (meta.has_technician) {
          <ion-item>
            <ion-label position="stacked">Técnico *</ion-label>
            <ion-select formControlName="user_id" interface="popover" placeholder="Selecionar">
              @for (u of technicians; track u) {
                <ion-select-option [value]="u.id">{{ u.name }}</ion-select-option>
              }
            </ion-select>
          </ion-item>
        }
        @for (fi of meta.form_inputs; track fi) {
          @switch (fi.type) {
            @case ('text') {
              <ion-item>
                <ion-label position="stacked">{{ fi.label }} @if (fi.required) {
                  <span>*</span>
                }</ion-label>
                <ion-input [formControlName]="key(fi)"></ion-input>
              </ion-item>
            }
            @case ('number') {
              <ion-item>
                <ion-label position="stacked">{{ fi.label }} @if (fi.required) {
                  <span>*</span>
                }</ion-label>
                <ion-input type="number" [formControlName]="key(fi)"></ion-input>
              </ion-item>
            }
            @case ('date') {
              <ion-item>
                <ion-label position="stacked">{{ fi.label }} @if (fi.required) {
                  <span>*</span>
                }</ion-label>
                <ion-datetime presentation="date" [formControlName]="key(fi)"></ion-datetime>
              </ion-item>
            }
            @case ('textarea') {
              <ion-item>
                <ion-label position="stacked">{{ fi.label }} @if (fi.required) {
                  <span>*</span>
                }</ion-label>
                <ion-textarea autoGrow="true" [formControlName]="key(fi)"></ion-textarea>
              </ion-item>
            }
            @case ('checkbox') {
              <ion-item lines="none">
                <ion-checkbox slot="start" [formControlName]="key(fi)"></ion-checkbox>
                <ion-label>{{ fi.label }} @if (fi.required) {
                  <span>*</span>
                }</ion-label>
              </ion-item>
            }
            @case ('radio') {
              <ion-item>
                <ion-label>{{ fi.label }}</ion-label>
                <ion-radio-group [formControlName]="key(fi)">
                  <ion-item><ion-label>Sim</ion-label><ion-radio value="Sim"></ion-radio></ion-item>
                  <ion-item><ion-label>Não</ion-label><ion-radio value="Não"></ion-radio></ion-item>
                </ion-radio-group>
              </ion-item>
            }
            @case ('photos') {
              <ion-item>
                <ion-label position="stacked">{{ fi.label }}</ion-label>
                <input type="file" multiple (change)="onPickPhotos(fi, $event.target.files)">
                @if (photos[fi.id]?.length) {
                  <ion-note class="ion-padding-top">
                    {{ photos[fi.id].length }} ficheiro(s) carregado(s)
                  </ion-note>
                }
                @if (uploading[fi.id]) {
                  <div class="ion-padding-top">
                    <ion-spinner name="dots"></ion-spinner> a carregar fotos…
                  </div>
                }
              </ion-item>
            }
          }
        }
      </ion-list>
      <div class="ion-padding">
        <ion-button expand="block" type="submit" [disabled]="submitting || hasAnyUploading">
          {{ submitting ? 'A enviar…' : 'Submeter' }}
        </ion-button>
      </div>
    </form>
  </ion-content>
} @else {
  <ion-content>
    <ion-list>
      @for (s of [1,2,3,4]; track s) {
        <ion-item>
          <ion-label>
            <h2><span class="skeleton"></span></h2>
            <p><span class="skeleton"></span></p>
          </ion-label>
        </ion-item>
      }
    </ion-list>
  </ion-content>
}

